<!DOCTYPE html>
<html lang="en">
    <head>

        <meta charset="utf-8">

        <style>

            .axis path,
            .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
            }

            .axis text {
                font-family: sans-serif;
                font-size: 11px;
            }
            .title {
              font: 300 38px Helvetica Neue;
              fill: #666;
            }
        </style>
        <title>D3 Test</title>
        <script type="text/javascript" src="d3/d3.v3.js"></script>

    </head>
    <body>

        <script type="text/javascript">
					   
            d3.json("whole_month.json", function(root){ 
            //ALL code using the data here
            	//console.log(root)
                var w = 800;
                var h = 800;

                var tooltip = d3.select("body")
					.append("div")
					.style("position", "absolute")
					.style("z-index", "10")
					.style("visibility", "hidden")
					.text("a simple tooltip");

                var svg = d3.select("body")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

                var topWords = getWords();
                var topUsers = getUsers();
                var topRelations = getRelations();
                
               	mapWords(topWords,w,h);
               	[userLocations, usersIndexed] = mapUsers(topWords,topUsers,w,h);
               	createCircles(userLocations);
               	mapRelations(topRelations,usersIndexed);


               	//Analyse the dataset and returns the most used words
				function getWords(){
					//EXTRACT FROM DATAFILE!!	
					
					//This is just a toy example	
					return ["A","B","C"];
				}

				function getUsers(){
					//EXTRACT FROM DATAFILE!!
					
					//This is just a toy example
					return [ ["anne", "abel", "arend",'annemies','anja'], 
					["bert", "bonno","bill","bob"], ["carl","cato",'catelijn',"christina"]];
					}
				
				function getRelations(){
					//EXTRACT FROM DATAFILE!!
					
					return [['annemies','anja'],['anne','catelijn'],
					['bert','anne'], ['bonno','cato'] ];
				}
				
				//Add title in center
				var word = svg.append("text")
                    .attr("class","title")
                    .attr("y", h/2)
                    .attr("x", w/2 - 30)
                    .text("Bey");
                    
                //My first useless little test point
                var point1 = svg.append("circle")
                	.attr("cx",300)
                	.attr("cy",300)
                	.attr("r",5)
                	.attr("user",'Stranger')
                	.attr("Tag",'None')
                	.attr("fill","red");
                	
                //My second useless little test point
                var point2 = svg.append("circle")
                	.attr("cx",500)
                	.attr("cy",500)
                	.attr("r",5)
                	.attr("user",'Loner')
                	.attr("Tag",'None')
                	.attr("fill","purple");
				
				//Place the top words in the correct location in the svg
				function mapWords(words,w,h){
					var padding = 100;
					cx = w/2;
					cy = h/2;
					radius = Math.min(cx,cy) - padding;		
					svg.selectAll("text")
		                .data(words)
		                .enter()
		                .append("text")
		                .text(function(d) {
		                    return d;
		                })
		                .attr("x", function(d, i) {
		                    return cx + radius*Math.cos(i/words.length*Math.PI*2);
		                })
		                .attr("y", function(d,i) {
		                    return cy + radius*Math.sin(i/words.length*Math.PI*2);
		                })
				}
				//Place the users in the correcct location in the svg
				function mapUsers(words,users, w,h){
					var userDict = [];
					var userIndexDict = {};
					var padding = 100;
					cx = w/2;
					cy = h/2;
					radius = Math.min(cx,cy) - padding;

					for (i=0; i<users.length; i++){
						wordX = cx + radius*Math.cos(i/words.length*Math.PI*2)+5; //+5 and
						wordY = cy + radius*Math.sin(i/words.length*Math.PI*2)-5; //-5 added to compensate for Word length
						for (j= 0; j<users[i].length;j++){
							circleX = wordX + 40*Math.cos(j/users[i].length*Math.PI*2);
							circleY = wordY + 40*Math.sin(j/users[i].length*Math.PI*2);
							/*
							svg.append("circle")
				        		.attr("cx", circleX )
				        		.attr("cy", circleY)
				        		.attr("r",5)
				        		.attr("Word",words[i])
				        		.attr("User",users[i][j])
				        		.attr("fill","lime");
				        	*/
				        	userX = wordX + 40*Math.cos(j/users[i].length*Math.PI*2);
				        	userY = wordY + 40*Math.sin(j/users[i].length*Math.PI*2);
				        	//userDict[users[i][j]] = [userX,userY];
				        	smallDict = {};
				        	smallDict['name'] = users[i][j];
				        	smallDict['x'] =  userX;
				        	smallDict['y'] =  userY;
				        	userDict.push(smallDict);
				        	userIndexDict[users[i][j]] = {'x': userX,'y': userY}		
						}
					}
					return [userDict, userIndexDict];
				}
				
				//Places circles on the svg
				function createCircles(dataset){
               		svg.selectAll("circle")
	               		.data(dataset)
	               		.enter()
	               		.append("svg:circle")
			            .attr("cx", function(d) {return d.x;})
						.attr("cy", function(d) {return d.y;})
						.attr("fill", "lime")
						.attr("r", 10)
						//Adds notification on mouseover
						.on("mouseover", function(d){
							var xPos = parseFloat(d3.select(this).attr("cx"));
							var yPos = parseFloat(d3.select(this).attr("cy"));
							svg.append("text")
								  .attr("id", "tooltip")
								  .attr("x", xPos)
								  .attr("y", yPos)
								  .attr("text-anchor", "middle")
								  .attr("font-family", "sans-serif")
								  .attr("font-size", "11px")
								  .attr("font-weight", "bold")
								  .attr("fill", "black")
								  .text(d.name);
						})
						.on("mouseout", function() {
							//Remove the tooltip
							d3.select("#tooltip").remove();
						})
				}

				//Places the relationship lines between the correct points
				function mapRelations(relations,userLocations){
					console.log('rel',relations);
					console.log('loc',userLocations);
					svg.selectAll('line')
						.data(relations)
						.enter()
						.append('line')
		            	.attr('x1',function(d, i) {
							//from 1rst person in relationship take 1st (x) coord
							console.log(userLocations[d[0]])
		                    return [userLocations[d[0]].x]
		                })
		            	.attr('x2',function(d, i) {

		                    return userLocations[d[1]].x
		                })
		            	.attr('y1',function(d, i) {

		                    return userLocations[d[0]].y
		                })
		            	.attr('y2',function(d, i) {

		                    return userLocations[d[1]].y
		                })
		            	.attr('stroke', 'grey')
		            	.attr('opacity',0.2)
		            	.attr('stroke-width',3); 						
				}


});
        </script>
            
    </body>
</html>  
